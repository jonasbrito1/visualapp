// =============================================
// VISUALAPP - Prisma Schema
// =============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ---- Enums ----

enum Role {
  CUSTOMER
  ADMIN
}

enum Gender {
  MENINO
  MENINA
  UNISSEX
}

enum OrderStatus {
  PENDING      // Aguardando confirmação
  CONFIRMED    // Confirmado
  PREPARING    // Em preparação
  SHIPPED      // Enviado
  DELIVERED    // Entregue
  CANCELLED    // Cancelado
}

enum PaymentMethod {
  PIX
  CREDIT_CARD
  DEBIT_CARD
}

enum PaymentStatus {
  PENDING     // Aguardando
  PROCESSING  // Processando
  PAID        // Pago
  FAILED      // Falhou
  REFUNDED    // Estornado
}

// ---- Models ----

model User {
  id              String    @id @default(cuid())
  email           String    @unique
  password        String
  name            String
  phone           String?
  role            Role      @default(CUSTOMER)
  lgpdConsent     Boolean   @default(false)
  lgpdConsentAt   DateTime?
  lgpdConsentIp   String?
  active          Boolean   @default(true)
  emailVerified   DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  children    Child[]
  orders      Order[]
  cartItems   CartItem[]
  sessions    Session[]

  @@map("users")
}

model Child {
  id              String   @id @default(cuid())
  userId          String
  name            String
  birthDate       DateTime
  gender          Gender
  clothingSize    String   // 1, 2, 4, 6, 8, 10, 12, 14, 16, PP, P, M, G
  shoeSize        String?
  weight          Float?   // kg
  height          Float?   // cm
  stylePrefs      String[] // casual, esportivo, elegante, colorido, neutro, romantico
  occasionPrefs   String[] // escola, passeio, festa, esporte, praia, dormir
  colorPrefs      String[] // azul, rosa, verde, amarelo, vermelho, neutro, colorido
  skinTone        String?  // clara, media, escura
  allergies       String?
  notes           String?
  avatar          String?  // emoji ou cor para identificar
  active          Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  recommendations Recommendation[]
  orders          Order[]

  @@map("children")
}

model Category {
  id          String    @id @default(cuid())
  name        String    @unique
  slug        String    @unique
  description String?
  imageUrl    String?
  order       Int       @default(0)
  active      Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  products    Product[]

  @@map("categories")
}

model Product {
  id            String   @id @default(cuid())
  name          String
  slug          String   @unique
  description   String?  @db.Text
  price         Decimal  @db.Decimal(10, 2)
  comparePrice  Decimal? @db.Decimal(10, 2) // preço original (para mostrar desconto)
  categoryId    String
  brand         String?
  gender        Gender
  ageMin        Int      // idade mínima em meses
  ageMax        Int      // idade máxima em meses
  colors        String[] // cores disponíveis
  tags          String[] // casual, esportivo, festa, escola, praia, etc.
  material      String?
  careInstructions String? @db.Text
  active        Boolean  @default(true)
  featured      Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  category        Category       @relation(fields: [categoryId], references: [id])
  sizes           ProductSize[]
  images          ProductImage[]
  orderItems      OrderItem[]
  recommendations Recommendation[]
  cartItems       CartItem[]

  @@map("products")
}

model ProductSize {
  id        String  @id @default(cuid())
  productId String
  size      String
  stock     Int     @default(0)
  sku       String? @unique

  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, size])
  @@map("product_sizes")
}

model ProductImage {
  id        String  @id @default(cuid())
  productId String
  url       String
  alt       String?
  order     Int     @default(0)
  isPrimary Boolean @default(false)

  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("product_images")
}

model Order {
  id             String        @id @default(cuid())
  orderNumber    String        @unique @default(cuid())
  userId         String
  childId        String?
  status         OrderStatus   @default(PENDING)
  paymentMethod  PaymentMethod?
  paymentStatus  PaymentStatus @default(PENDING)
  paymentId      String?
  subtotal       Decimal       @db.Decimal(10, 2)
  discount       Decimal       @db.Decimal(10, 2) @default(0)
  shipping       Decimal       @db.Decimal(10, 2) @default(0)
  total          Decimal       @db.Decimal(10, 2)
  notes          String?       @db.Text
  pixCode        String?       @db.Text // Pix copia e cola
  pixQrCode      String?       // Base64 QR Code
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  user       User          @relation(fields: [userId], references: [id])
  child      Child?        @relation(fields: [childId], references: [id])
  items      OrderItem[]
  address    OrderAddress?

  @@map("orders")
}

model OrderItem {
  id        String  @id @default(cuid())
  orderId   String
  productId String
  size      String
  color     String?
  quantity  Int
  price     Decimal @db.Decimal(10, 2)

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@map("order_items")
}

model OrderAddress {
  id         String  @id @default(cuid())
  orderId    String  @unique
  recipientName String
  street     String
  number     String
  complement String?
  district   String
  city       String
  state      String
  zipCode    String
  country    String  @default("BR")

  order      Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("order_addresses")
}

model CartItem {
  id        String   @id @default(cuid())
  userId    String
  productId String
  size      String
  quantity  Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId, size])
  @@map("cart_items")
}

model Recommendation {
  id          String   @id @default(cuid())
  childId     String
  productId   String
  score       Float    // 0.0 - 1.0
  reason      String?  @db.Text // explicação gerada pela IA
  isViewed    Boolean  @default(false)
  createdAt   DateTime @default(now())

  child   Child   @relation(fields: [childId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([childId, productId])
  @@map("recommendations")
}

// ---- Auth (NextAuth) ----

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ---- Settings ----

model AppSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String   @db.Text
  updatedAt DateTime @updatedAt

  @@map("app_settings")
}
